#include "soc.h"

// #define DEBUG
float data_084A[][2] = {
    {0, 4.151877133},
    {50, 4.116793623},
    {100, 4.098654906},
    {150, 4.080321195},
    {200, 4.072200678},
    {250, 4.063885503},
    {300, 4.057612949},
    {350, 4.054238716},
    {400, 4.050968294},
    {450, 4.047671012},
    {500, 4.045603605},
    {550, 4.04077309},
    {600, 4.037846365},
    {650, 4.027601233},
    {700, 4.017687415},
    {750, 4.008147842},
    {800, 3.99554749},
    {850, 3.97949842},
    {2950, 3.504798539},
    {3000, 3.49325194},
    {3050, 3.480934403},
    {3100, 3.465807394},
    {3150, 3.452363074},
    {3200, 3.439337435},
    {3250, 3.425609794},
    {3300, 3.414190508},
    {3350, 3.406370864},
    {3400, 3.392937134},
    {3450, 3.376620888},
    {3500, 3.356255697},
    {3550, 3.328343885},
    {3600, 3.293013491},
    {3650, 3.250318762},
    {3700, 3.200316455},
    {3750, 3.142826763},
    {3800, 3.07508581},
    {3850, 3.003647629},
    {3900, 2.914171472},
    {3950, 2.793393496},
    {4000, 2.596836035},
};
float data_2_1A[][2] = {
    {0, 4.154425484},
    {50, 4.083263821},
    {100, 4.063549516},
    {150, 4.042238237},
    {200, 4.034689351},
    {250, 4.020832801},
    {300, 4.017928535},
    {350, 4.014476762},
    {400, 4.01115777},
    {450, 4.008192709},
    {500, 4.001351755},
    {550, 3.99793705},
    {600, 3.994799312},
    {650, 3.984769804},
    {3250, 3.393514601},
    {3300, 3.376235428},
    {3350, 3.362282358},
    {3400, 3.346437975},
    {3450, 3.327004622},
    {3500, 3.309901138},
    {3550, 3.282129769},
    {3600, 3.251369406},
    {3650, 3.206812259},
    {3700, 3.153637155},
    {3750, 3.086833605},
    {3800, 3.008841269},
    {3850, 2.905632649},
    {3900, 2.733826199},
    {3950, 2.56423955}
};
float data_4_2A[][2] = {
    {0, 4.087258248},
    {50, 4.020683665},
    {100, 4.000788907},
    {150, 3.986788325},
    {200, 3.97477539},
    {250, 3.968176722},
    {300, 3.961715481},
    {350, 3.958088991},
    {400, 3.955006285},
    {450, 3.950297777},
    {500, 3.944799913},
    {550, 3.942066162},
    {600, 3.935172413},
    {650, 3.928385749},
    {700, 3.91774458},
    {3300, 3.312330619},
    {3350, 3.295896888},
    {3400, 3.280962706},
    {3450, 3.260712947},
    {3500, 3.236970788},
    {3550, 3.210438078},
    {3600, 3.18020185},
    {3650, 3.13808635},
    {3700, 3.082619716},
    {3750, 3.014365042},
    {3800, 2.929598873},
    {3841.620112, 2.834210762},
    {3900, 2.50403025},
    {3874.301676, 2.729806598},
    {3893.854749, 2.604664391},
    {3888.268156, 2.663822526}
};
float data_10A[][2] = {
    {0, 3.971520667},
    {50, 3.88516019},
    {100, 3.862006584},
    {150, 3.852688297},
    {200, 3.845595274},
    {250, 3.842596397},
    {300, 3.839192605},
    {350, 3.835941227},
    {400, 3.834403951},
    {3150, 3.240698174},
    {3200, 3.227502206},
    {3250, 3.214851144},
    {3300, 3.201438027},
    {3350, 3.183711806},
    {3400, 3.166075286},
    {3450, 3.145023065},
    {3500, 3.111189165},
    {3550, 3.101258347},
    {3600, 3.069033106},
    {3650, 3.029331005},
    {3700, 2.985774193},
    {3775.139665, 2.895667688},
    {3813.96648, 2.826210546},
    {3869.553073, 2.711188003},
    {3900, 2.631529125},
    {3950, 2.51649918},
    {3743.01676, 2.941410694},
    {3924.581006, 2.56370876},
    {3846.368715, 2.777588168}
};
float data_20A[][2] = {
    {0, 3.796260903},
    {50, 3.690016515},
    {100, 3.677297221},
    {150, 3.673885272},
    {200, 3.673884167},
    {250, 3.677226993},
    {300, 3.677217033},
    {350, 3.673959509},
    {3100, 3.155031249},
    {3150, 3.144951453},
    {3200, 3.134640447},
    {3250, 3.121453922},
    {3300, 3.108854281},
    {3350, 3.096105703},
    {3400, 3.076578633},
    {3450, 3.055866671},
    {3500, 3.038503719},
    {3550, 3.00800526},
    {3600, 2.982374781},
    {3650, 2.957560066},
    {3700, 2.90918381},
    {3750, 2.861463238},
    {3800, 2.813023441},
    {3850, 2.72183678},
    {3900, 2.608901733},
    {3927.653631, 2.503381795},
    {3877.094972, 2.6592719}
};




// Function to map a value from one range to another
float map_(float x, float in_min, float in_max, float out_min, float out_max) {
    return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
}

// Function to search for the index in the array based on a value
int search_index(float x, float arr[][2]) {
    int i = 0;
    while (arr[i++][1] > x);
    return i;
}

// Function to transform battery voltage into SOC (State of Charge)
float SOC_Transform(float ref_Voltage, float ref_Current) {
    if (ref_Current <= 0.84) {
        int mah_84 = search_index(ref_Voltage, data_084A);
        return 1 - (map_(ref_Voltage, data_084A[mah_84][1], data_084A[mah_84 - 1][1], data_084A[mah_84][0], data_084A[mah_84 - 1][0]) / 4200);
    } else if (ref_Current <= 2.1) {
        int mah_84 = search_index(ref_Voltage, data_084A);
        int mah_21 = search_index(ref_Voltage, data_2_1A);
        float SOC_084A = 1 - (map_(ref_Voltage, data_084A[mah_84][1], data_084A[mah_84 - 1][1], data_084A[mah_84][0], data_084A[mah_84 - 1][0]) / 4200);
        float SOC_21A = 1 - (map_(ref_Voltage, data_2_1A[mah_21][1], data_2_1A[mah_21 - 1][1], data_2_1A[mah_21][0], data_2_1A[mah_21 - 1][0]) / 4200);
        return map_(ref_Current, 0.84, 2.1, SOC_084A, SOC_21A);
    } else if (ref_Current <= 4.2) {
        int mah_21 = search_index(ref_Voltage, data_2_1A);
        int mah_42 = search_index(ref_Voltage, data_4_2A);
        float SOC_21A = 1 - (map_(ref_Voltage, data_2_1A[mah_21][1], data_2_1A[mah_21 - 1][1], data_2_1A[mah_21][0], data_2_1A[mah_21 - 1][0]) / 4200);
        float SOC_42A = 1 - (map_(ref_Voltage, data_4_2A[mah_42][1], data_4_2A[mah_42 - 1][1], data_4_2A[mah_42][0], data_4_2A[mah_42 - 1][0]) / 4200);
        return map_(ref_Current, 2.1, 4.2, SOC_21A, SOC_42A);
    } else if (ref_Current <= 10) {
        int mah_42 = search_index(ref_Voltage, data_4_2A);
        int mah_10 = search_index(ref_Voltage, data_10A);
        float SOC_42A = 1 - (map_(ref_Voltage, data_4_2A[mah_42][1], data_4_2A[mah_42 - 1][1], data_4_2A[mah_42][0], data_4_2A[mah_42 - 1][0]) / 4200);
        float SOC_10A = 1 - (map_(ref_Voltage, data_10A[mah_10][1], data_10A[mah_10 - 1][1], data_10A[mah_10][0], data_10A[mah_10 - 1][0]) / 4200);
        return map_(ref_Current, 4.2, 10, SOC_42A, SOC_10A);
    } else if (ref_Current <= 20) {
        int mah_10 = search_index(ref_Voltage, data_10A);
        int mah_20 = search_index(ref_Voltage, data_20A);
        float SOC_10A = 1 - (map_(ref_Voltage, data_10A[mah_10][1], data_10A[mah_10 - 1][1], data_10A[mah_10][0], data_10A[mah_10 - 1][0]) / 4200);
        float SOC_20A = 1 - (map_(ref_Voltage, data_20A[mah_20][1], data_20A[mah_20 - 1][1], data_20A[mah_20][0], data_20A[mah_20 - 1][0]) / 4200);
        return map_(ref_Current, 10, 20, SOC_10A, SOC_20A);
    }
}